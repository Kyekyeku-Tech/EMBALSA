<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily Submission Dashboard</title>
  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <link rel="stylesheet" href="/CSS/lsa.css" />
  <link rel="icon" href="/Images/emba.jpg" type="image/x-icon">
</head>
<body>
  <!-- Submission Form Container -->
  <div class="container" id="submissionContainer">
    <div class="download-buttons">
      <button onclick="toggleStatementForm()">Get Statement</button>
    </div>

    <div class="dashboard">
      <h4>Daily Submission Dashboard</h4>
      <p class="totals">Total Amount: GHC <span id="totalAmount">0</span></p>
      <p class="totals">Total Fees: GHC <span id="totalFees">0</span></p>
      <p class="totals">Unique serve: <span id="totalUnique">0</span></p>
    </div>

    <img src="/Images/emba.jpg" alt="Emba Logo" class="logo">

    <form id="expensesForm" action="https://script.google.com/macros/s/AKfycbwzeRS94NsMwmhEhbT1kb786TL68_ahT0r6R1n0wMbUhr_4GQDFaYArz1po9K4rCypz_g/exec" method="post" onsubmit="return handleFormSubmit(event)">
      <input type="hidden" name="sheetName" value="ANAJI-K">
      <input type="hidden" name="TIMESTAMP" id="TIMESTAMP">

      <label>Agent Name</label>
      <input type="text" name="AGENTNAME" id="AgentName" required>
      <div class="dropdown" id="agentDropdown"></div>

      <label>Type</label>
      <select name="TYPE" required>
        <option value="">Select Type</option>
        <option value="E-CASH">E-Cash</option>
        <option value="PHYSICAL-CASH">Physical Cash</option>
      </select>

      <label>Amount</label>
      <input type="number" name="AMOUNT" id="AMOUNT" required oninput="calculateFees()">

      <label>Fees</label>
      <input type="number" name="FEES" id="FEES" readonly>

      <button type="submit">Submit</button>
    </form>
  </div>

  <!-- Statement Container -->
  <div class="container" id="statementContainer" style="display: none;">
    <h3 style="color: #fff;">Download Submission Statement</h3>

    <label for="sheetName">Select Sheet</label>
    <select id="sheetName">
      <option value="ANAJI-K">ANAJI-K</option>
      <!-- More sheets can be added here -->
    </select>

    <label for="allStartDate">Start Date</label>
    <input type="date" id="allStartDate" required>

    <label for="allEndDate">End Date</label>
    <input type="date" id="allEndDate" required>

    <button onclick="downloadAllSubmissions()">Download Statement</button>
    <button onclick="toggleStatementForm()" style="margin-top: 10px;">Back to Form</button>
  </div>

  <!-- SCRIPT -->
  <script>
    async function downloadAllSubmissions() {
    const startDate = document.getElementById("allStartDate").value;
    const endDate = document.getElementById("allEndDate").value;
    const sheetName = document.getElementById("sheetName").value;

    if (!startDate || !endDate || !sheetName) {
      return Swal.fire("Missing Input", "Please fill all fields.", "warning");
    }

    const url = `https://script.google.com/macros/s/AKfycbwzeRS94NsMwmhEhbT1kb786TL68_ahT0r6R1n0wMbUhr_4GQDFaYArz1po9K4rCypz_g/exec?sheetName=${encodeURIComponent(sheetName)}&startDate=${startDate}&endDate=${endDate}`;

    Swal.fire({ title: "Fetching...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });

    try {
      const response = await fetch(url);
      const data = await response.json();

      if (!data || data.length <= 1) {
        return Swal.fire("No Records", "No submissions found in this date range.", "info");
      }

      const sheet = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, sheet, "Submissions");

      const filename = `All_Submissions_${sheetName}_${startDate}_to_${endDate}.xlsx`;
      XLSX.writeFile(wb, filename);

      Swal.close();
    } catch (err) {
      console.error(err);
      Swal.fire("Error", "Could not fetch data.", "error");
    }
  }
     const agents = [
       "Dadzie dadzie Ent",
      "David ainoo ST Padua Ventures",
      "DANWIN VENTURES",
      "Victory Enterprise",
      "Elizabeth Ansah",
      "Blessing Evelyn kinnah",
      "Deborah Addae Debbyliz Ventures",
      "Patrick  kizito botsio",
      "Joshua Anaman 90",
      "ELSOM VENTURES",
      "Powerful  saviour-Patrick kizito botsio",
      "ST Padua Ventures-David Ainoo",
      "DEBORAH ADDAE",
      "Joshua Anaman  Enterprise",
      "Charles Yankey  cy Telnecom",
      "Allawakubur Ventures- Hawa",
      "MAX POLY PRODUCTS",
      "Godfred Fuachie SRC Ventures",
      "Pepassin Enterprise - Millicent",
      "Fatimah logo AL Wakerley F .J Enterprise",
      "VIda Amoah Zeetonia Ventures",
      "Isaac Born to win",
      "JustBee Ventures - Gifty Baffoe",
      "Ebenezer Ackon Ent-Isaac opoku",
      "Zinabu Halidu-Paul is able",
      "RHODA MENSAH-Rhodwusu",
      "Kofi dream big-Anthony",
      "Amamata sadick Enterprise",
      "Alice  Cobbina -Anna Asante"
    ];


        const agentInput = document.getElementById("AgentName");
        const dropdown = document.getElementById("agentDropdown");
    
        agentInput.addEventListener("input", function () {
            const inputValue = this.value.toLowerCase();
            dropdown.innerHTML = "";
            dropdown.style.display = "none";
    
            if (inputValue.length >= 2) {
                const matches = agents.filter(agent => agent.toLowerCase().includes(inputValue));
                if (matches.length > 0) {
                    dropdown.style.display = "block";
                    matches.forEach(match => {
                        const option = document.createElement("div");
                        option.textContent = match;
                        option.addEventListener("click", function () {
                            agentInput.value = match;
                            dropdown.style.display = "none";
                        });
                        dropdown.appendChild(option);
                    });
                }
            }
        });
    
        document.addEventListener("click", function (e) {
            if (!agentInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = "none";
            }
        });
    
        agentInput.addEventListener("focus", function () {
            const rect = agentInput.getBoundingClientRect();
            dropdown.style.top = rect.bottom + "px";
            dropdown.style.left = rect.left + "px";
            dropdown.style.width = rect.width + "px";
        });
    
        function initializeDashboard() {
            const todayDate = new Date().toLocaleDateString();
            const lastUpdateDate = localStorage.getItem("lastUpdateDate");
            if (lastUpdateDate !== todayDate) {
                resetDashboard();
            } else {
                updateDashboard();
            }
        }
    
        function updateDashboard() {
            document.getElementById("totalAmount").textContent = parseFloat(localStorage.getItem("totalAmount") || 0).toFixed(2);
            document.getElementById("totalFees").textContent = parseFloat(localStorage.getItem("totalFees") || 0).toFixed(2);
            document.getElementById("totalUnique").textContent = JSON.parse(localStorage.getItem("uniqueAgents") || "[]").length;
        }
    
        function resetDashboard() {
            localStorage.setItem("lastUpdateDate", new Date().toLocaleDateString());
            localStorage.setItem("totalAmount", "0");
            localStorage.setItem("totalFees", "0");
            localStorage.setItem("uniqueAgents", JSON.stringify([]));
            updateDashboard();
        }
    
        function calculateFees() {
            const amount = parseFloat(document.getElementById('AMOUNT').value) || 0;
            const fees = amount * 0.002; // 0.2% of the amount
            document.getElementById('FEES').value = fees.toFixed(2);
        }
    
        function appendTimestamp() {
            const now = new Date();
            const timestamp = `${now.toLocaleDateString()} ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            document.getElementById('TIMESTAMP').value = timestamp;
        }
    
        function scheduleMidnightReset() {
            setInterval(() => {
                const todayDate = new Date().toLocaleDateString();
                const lastUpdateDate = localStorage.getItem("lastUpdateDate");
                if (lastUpdateDate !== todayDate) {
                    resetDashboard();
                    Swal.fire("New Day!", "Dashboard reset for today.", "info");
                }
            }, 60 * 1000);
        }
    
        function sendSMS(amount, fees, totalFees) {
    const apiKey = "ub8mxDfZsERBob8Vp1tJLXtyI";
    const senderId = "PAYG";
    const recipient = "+233248528989"; // You can make this dynamic
    const message = `Anaji-K has served GHS${amount} on PAYG, GHS${fees} commission earned. Total commission in the day is GHS${totalFees}`;

    const payload = {
        sender: senderId,
        message: message,
        recipient: [recipient],
        is_schedule: false
    };

    return fetch(`https://api.mnotify.com/api/sms/quick?key=${apiKey}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => console.log("SMS sent successfully:", data))
    .catch(error => console.error("Error sending SMS:", error));
}
    

        function handleFormSubmit(event) {
            event.preventDefault();
            appendTimestamp();
    
            const form = document.getElementById("expensesForm");
            const formData = new FormData(form);
    
            const agentName = document.getElementById("AgentName").value;
            const amount = parseFloat(document.getElementById('AMOUNT').value) || 0;
            const fees = parseFloat(document.getElementById('FEES').value) || 0;
            const timestamp = formData.get("TIMESTAMP");
    
            // Save transaction with timestamp first
            let transactions = JSON.parse(localStorage.getItem("transactions") || "[]");
            transactions.push({
                timestamp,
                agentName,
                type: formData.get("TYPE"),
                amount,
                fees
            });
            localStorage.setItem("transactions", JSON.stringify(transactions));
    
            const submitButton = form.querySelector("button[type='submit']");
            submitButton.disabled = true;
    
            Swal.fire({
                title: 'Submitting...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
    
            const smsPromise = sendSMS(amount, fees, (parseFloat(localStorage.getItem("totalFees")) || 0) + fees);
            const formPromise = fetch(form.action, {
                method: form.method,
                body: formData
            });
    
            Promise.all([smsPromise, formPromise])
                .then(([smsResponse, formResponse]) => {
                    if (formResponse.ok) {
                        let totalAmount = parseFloat(localStorage.getItem("totalAmount")) || 0;
                        let totalFees = parseFloat(localStorage.getItem("totalFees")) || 0;
                        let uniqueAgents = JSON.parse(localStorage.getItem("uniqueAgents")) || [];
    
                        if (!uniqueAgents.includes(agentName)) {
                            uniqueAgents.push(agentName);
                            localStorage.setItem("uniqueAgents", JSON.stringify(uniqueAgents));
                        }
    
                        totalAmount += amount;
                        totalFees += fees;
    
                        localStorage.setItem("totalAmount", totalAmount);
                        localStorage.setItem("totalFees", totalFees);
    
                        updateDashboard();
    
                        Swal.fire("Submission Successful!", "Your data has been recorded.", "success");
                        form.reset();
                    } else {
                        Swal.fire("Error!", "Data submission failed.", "error");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    Swal.fire("Error!", "Something went wrong.", "error");
                })
                .finally(() => {
                    submitButton.disabled = false;
                });
        }
    // The toggle fix
    function toggleStatementForm() {
      const submission = document.getElementById("submissionContainer");
      const statement = document.getElementById("statementContainer");
      submission.style.display = submission.style.display === "none" ? "block" : "none";
      statement.style.display = statement.style.display === "none" ? "block" : "none";
    }

    initializeDashboard();
    scheduleMidnightReset();
  </script>
</body>
</html>
